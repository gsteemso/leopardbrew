require 'extend/ENV/shared'

# ### Why `superenv`?
#
# 1. Only specify the environment we need (NO LDFLAGS for cmake)
# 2. Only apply compiler specific options when we are calling that compiler
# 3. Force all incpaths and libpaths into the cc instantiation (less bugs)
# 4. Cater toolchain usage to specific Xcode versions
# 5. Remove flags that we don't want or that will break builds
# 6. Simpler code
# 7. Simpler formula that *just work*
# 8. Build-system agnostic configuration of the tool-chain
module Superenv
  include SharedEnvExtension

  # @private
  attr_accessor :keg_only_deps, :deps

  attr_accessor :x11
  alias_method :x11?, :x11

  def self.extended(base); base.keg_only_deps = []; base.deps = []; end

  # @private
  def self.bin
    return unless MacOS.has_apple_developer_tools?
    HOMEBREW_LIBRARY/'ENV/super'
  end

  # Configure scripts generated by autoconf 2.61 or later export as_nl, which
  # we use as a heuristic for running under configure.
  def reset; super; delete('as_nl'); end

  # @private
  def setup_build_environment(formula = nil, archset = nil)
    super

    send(compiler)

    self['PATH']                   = determine_path
    self['PKG_CONFIG_PATH']        = determine_pkg_config_path
    self['PKG_CONFIG_LIBDIR']      = determine_pkg_config_libdir
    self['HOMEBREW_CCCFG']         = determine_cccfg
    self['HOMEBREW_OPTIMIZATION_LEVEL'] = 'Os'
    self['HOMEBREW_TEMP']          = HOMEBREW_TEMP.to_s
    self['HOMEBREW_SDKROOT']       = effective_sysroot
    self['HOMEBREW_OPTFLAGS']      = determine_optflags
    self['HOMEBREW_ARCHFLAGS']     = determine_archflags(archset)
    self['CMAKE_PREFIX_PATH']      = determine_cmake_prefix_path
    self['CMAKE_FRAMEWORK_PATH']   = determine_cmake_frameworks_path
    self['CMAKE_INCLUDE_PATH']     = determine_cmake_include_path
    self['CMAKE_LIBRARY_PATH']     = determine_cmake_library_path
    self['ACLOCAL_PATH']           = determine_aclocal_path
    self['M4']                     = OPTDIR/'m4/bin/m4' if deps.any?{ |d| d.name == 'libtool' }
    self['HOMEBREW_ISYSTEM_PATHS'] = determine_isystem_paths
    self['HOMEBREW_INCLUDE_PATHS'] = determine_include_paths
    self['HOMEBREW_LIBRARY_PATHS'] = determine_library_paths

    # On 10.9, the tools in /usr/bin proxy to the active developer directory.
    # This means we can use them for any combination of CLT and Xcode.
    self['HOMEBREW_PREFER_CLT_PROXIES'] = '1' if MacOS.version >= :mavericks

    # The HOMEBREW_CCCFG ENV variable is used by the ENV/cc tool to control compiler‐flag stripping.
    # It consists of a string of flag characters, some of them mutually exclusive.
    # O - Enables argument refurbishing.  Currently only active under the [bsd]make wrapper.
    # x - Enable C++11 mode.
    # g - Enable “-stdlib=libc++” for clang.
    # h - Enable “-stdlib=libstdc++” for clang.
    # K - Don't strip -arch <arch>, -m32, or -m64.
    # On 10.8 and newer, these flags will also be present:
    # s - Apply fix for sed’s Unicode support.
    # a - Apply fix for apr-1-config path.
  end # setup_build_environment

  private

  def determine_path
    paths = [Superenv.bin]

    # Formula dependencies can override standard tools.
    paths += deps.map { |d| d.opt_bin }

    # On 10.9, there are shims for all tools in /usr/bin.
    # On 10.7 and 10.8 we need to add these directories ourselves.
    if MacOS::Xcode.without_clt? && MacOS.version <= :mountain_lion
      paths << "#{MacOS::Xcode.prefix}/usr/bin"
      paths << "#{MacOS::Xcode.toolchain_path}/usr/bin"
    end

    paths << MacOS::X11.bin if x11?
    paths += %w[/usr/bin /bin /usr/sbin /sbin]

    # Homebrew’s apple-gcc42 will be outside the PATH in superenv, so xcrun may not be able to find
    # it without help.
    case homebrew_cc
      when 'gcc-4.2'
        # ignore Homebrew’s if one is already installed
        paths << if (agcc42 = MacOS.locate('gcc-4.2'))
                   agcc42.realpath.parent
                 elsif (agcc42 = Formula['apple-gcc42']) and agcc42.any_version_installed?
                   agcc42.opt_bin
                 end
      when GNU_GCC_REGEXP
        gcc_formula = gcc_version_formula($&)
        paths << gcc_formula.opt_bin if gcc_formula.installed?
    end
    paths.to_path_s
  end # determine_path

  def determine_pkg_config_path
    paths  = deps.map { |d| "#{d.opt_lib}/pkgconfig" }
    paths += deps.map { |d| "#{d.opt_share}/pkgconfig" }
    paths.to_path_s
  end

  def determine_pkg_config_libdir
    paths = %W[/usr/lib/pkgconfig #{HOMEBREW_LIBRARY}/ENV/pkgconfig/#{MacOS.version}]
    paths << "#{MacOS::X11.lib}/pkgconfig" << "#{MacOS::X11.share}/pkgconfig" if x11?
    paths.to_path_s
  end

  def determine_cccfg
    # Always allow controlling the build architecture.
    s = 'K'
    if MacOS.version >= :mountain_lion
      # Fix issue with sed barfing on unicode characters on Mountain Lion.
      s << 's'
      # Fix issue with apr-1-config having broken paths >= 10.8.
      s << 'a'
    end
    s
  end # determine_cccfg

  def effective_sysroot;
    @effective_sysroot ||= MacOS::Xcode.without_clt? ? MacOS.sdk_path.to_s : nil
  end

  def determine_optflags
    compiler == :clang ? "-march=native" : CPU.optimization_flags(Target.model, compiler_version)
  end # determine_optflags

  def determine_archflags(archset)
    if archset then archset.as_arch_flags
    elsif @build_archs then @build_archs.as_arch_flags
    elsif homebrew_build_archs then homebrew_build_archs.as_arch_flags
    else self['HOMEBREW_ARCHFLAGS'] || ''; end
  end # determine_archflags

  def determine_cmake_prefix_path
    paths = keg_only_deps.map { |d| d.opt_prefix.to_s }
    paths << HOMEBREW_PREFIX.to_s
    paths.to_path_s
  end

  def determine_cmake_frameworks_path
    paths = deps.map { |d| d.opt_frameworks.to_s }
    paths << "#{effective_sysroot}/System/Library/Frameworks" if MacOS::Xcode.without_clt?
    paths.to_path_s
  end

  def determine_cmake_include_path; common_include_paths.to_path_s; end

  def determine_cmake_library_path
    paths = []
    paths << MacOS::X11.lib.to_s if x11?
    paths << "#{effective_sysroot}/System/Library/Frameworks/OpenGL.framework/Versions/Current/Libraries"
    paths.to_path_s
  end # determine_cmake_library_path

  def determine_aclocal_path
    paths = keg_only_deps.map { |d| "#{d.opt_share}/aclocal" }
    paths << "#{HOMEBREW_PREFIX}/share/aclocal"
    paths << "#{MacOS::X11.share}/aclocal" if x11?
    paths.to_path_s
  end # determine_aclocal_path

  def determine_isystem_paths; (common_include_paths.unshift "#{HOMEBREW_PREFIX}/include").to_path_s; end

  def determine_include_paths; keg_only_deps.map { |d| d.opt_include.to_s }.to_path_s; end

  def determine_library_paths
    paths = keg_only_deps.map { |d| d.opt_lib.to_s }
    paths << "#{HOMEBREW_PREFIX}/lib"
    paths << MacOS::X11.lib.to_s if x11?
    paths << "#{effective_sysroot}/System/Library/Frameworks/OpenGL.framework/Versions/Current/Libraries"
    paths.to_path_s
  end # determine_library_paths

  def common_include_paths
    paths = []
    paths << "#{effective_sysroot}/usr/include/libxml2" unless deps.any? { |d| d.name == 'libxml2' }
    paths << "#{effective_sysroot}/usr/include/apache2" if MacOS::Xcode.without_clt?
    paths << MacOS::X11.include.to_s << "#{MacOS::X11.include}/freetype2" if x11?
    paths << "#{effective_sysroot}/System/Library/Frameworks/OpenGL.framework/Versions/Current/Headers"
  end # common_include_paths

  public

  def cccfg_add(datum)
    append('HOMEBREW_CCCFG', datum, '') unless self['HOMEBREW_CCCFG'].includes? datum
  end

  def cccfg_remove(datum)
    remove 'HOMEBREW_CCCFG', datum if self['HOMEBREW_CCCFG'].includes? datum
  end

  def set_build_archs(archset)
    archset = super
    self['HOMEBREW_ARCHFLAGS'] = archset.as_arch_flags
    self['HOMEBREW_OPTFLAGS'] = ''
    archset.each{ |a|
      CPU.optimization_flags(CPU.archmap(a), compiler_version).split(' ').each{ |fl|
        append 'HOMEBREW_OPTFLAGS', "-Xarch_#{a} #{fl}"
    } }
  end # set_build_archs

  # Super filters the build archs to the 32‐bit ones via set_build_archs.
  def m32; super; append 'HOMEBREW_ARCHFLAGS', '-m32'; end

  # Super filters the build archs to the 64‐bit ones via set_build_archs.
  def m64; super; append 'HOMEBREW_ARCHFLAGS', '-m64'; end

  def un_m32; super; remove 'HOMEBREW_ARCHFLAGS', '-m32'; end
  def un_m64; super; remove 'HOMEBREW_ARCHFLAGS', '-m64'; end

  def cxx11
    case homebrew_cc
      when 'clang' then cccfg_add 'x'; cccfg_remove 'h'; cccfg_add 'g'
      when GNU_CXX11_REGEXP then cccfg_add 'x'
      else raise "The selected compiler doesn't support C++11:  #{homebrew_cc}"
    end
  end # cxx11

  def libcxx; if compiler == :clang then cccfg_remove 'h'; cccfg_add 'g'; end; end

  def libstdcxx; if compiler == :clang then cccfg_remove 'g'; cccfg_add 'h'; end; end

  # @private
  def refurbish_args; cccfg_add 'O'; end

  %w[O3 O2 O1 O0 Os].each do |opt|
    define_method opt do self['HOMEBREW_OPTIMIZATION_LEVEL'] = opt; end
  end

  def no_optimization; delete 'HOMEBREW_OPTIMIZATION_LEVEL'; end

  def enable_warnings; self['HOMEBREW_DISABLE__W'] = 'yes'; end

  # @private
  def noop(*_args); end
  noops = []

  # These methods are no longer necessary under superenv, but are needed to
  # maintain an interface compatible with stdenv.
  noops.concat %w[fast O4 Og libxml2 set_cpu_flags macosxsdk remove_macosxsdk]

  # These methods provide functionality that has not yet been ported to
  # superenv.
  noops.concat %w[gcc_4_0_1 minimal_optimization]

  noops.each { |m| alias_method m, :noop }
end # module Superenv

class Array
  def to_path_s
    map(&:to_s).uniq.select{ |s| File.directory? s }.join(File::PATH_SEPARATOR).choke
  end
end
